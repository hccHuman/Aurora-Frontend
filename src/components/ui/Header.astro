---
/**
 * Header Component - Navigation and Branding
 *
 * Main application header with responsive navigation, search, cart, and user menu.
 * Includes desktop and mobile versions with proper accessibility attributes.
 *
 * Features:
 * - Logo and branding with link to home
 * - Navigation links (Home, Products, Offers) - conditionally shown based on `home` prop
 * - Search bar (desktop and mobile versions)
 * - Account dropdown menu (redirects to login if not authenticated)
 * - Shopping cart button with item count badge
 * - Theme toggle (light/dark mode)
 * - Responsive design (hidden on mobile, hamburger menu)
 * - Dark mode support with Tailwind classes
 * - Click-outside detection to close dropdowns
 *
 * Props:
 * - cartCount: Number of items in cart (default: 0)
 * - lang: Current language (en or es) for navigation URLs
 * - home: Boolean to show/hide home link
 *
 * Structure:
 * 1. Desktop header with flex layout
 * 2. Logo and brand name
 * 3. Desktop navigation menu
 * 4. Search bar with icon toggle
 * 5. Account menu dropdown (toggles on click)
 * 6. Cart menu dropdown with quick links
 * 7. Theme toggle component
 * 8. Mobile hamburger menu (visible only on small screens)
 * 9. Mobile dropdown menus (Account, Cart)
 * 10. Inline script for dropdown toggle behavior
 */
import { Image } from "astro:assets";
import AccountMenu from "../tsx/AccountMenu/AccountMenu";
import HeaderSearch from "../tsx/Header/HeaderSearch";
import ThemeToggle from "../tsx/ThemeToggle/ThemeToggle";
import CartCount from "../tsx/Header/CartCount";
const { lang, home, showSearch = false, searchCategoryId = null } = Astro.props;

import iconImg from "@/assets/icon.png";
import accountImg from "@/assets/Icons/dark/account.png";
import cartImg from "@/assets/Icons/dark/cart.png";
---
<link rel="stylesheet" href="/src/styles/Components/Header.css" />

<header
  class="w-full bg-slate-900 dark:bg-slate-950 text-white dark:text-slate-50 border-b border-sky-100 dark:border-slate-700 shadow-md transition-colors duration-300"
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between">
    <!-- LOGO SECTION -->
    <a
      href="/"
      class="flex items-center gap-2 font-bold text-xl tracking-wide hover:opacity-80 transition"
      aria-label="Aurora Shop Home"
    >
      <Image
        src={iconImg}
        alt={"Aurora Shop Logo"}
        class="w-16 sm:w-20 h-16 sm:h-20 rounded-full"
        inferSize={true}
      />
      <span>Hcc Shop</span>
    </a>

    <!-- DESKTOP NAVIGATION & ICONS (hidden on mobile, shown on md+) -->
    <div class="hidden md:flex items-center gap-6">
      {/* Main navigation links */}
      <nav class="flex gap-6 text-sm">
        {
          home && (
            <a href={`/${lang}/`} class="hover:text-red-400 transition">
              Inicio
            </a>
          )
        }
        <a href={`/${lang}/products/allproducts`} class="hover:text-red-400 transition">Productos</a
        >
        <a href={`/${lang}/products/offer`} class="hover:text-red-400 transition">Ofertas</a>
      </nav>

      <div class="flex items-center gap-4">
        <!-- Search component (desktop) -->
        { showSearch && (
          <div role="search">
            <HeaderSearch client:load placeholder="Buscar productos" categoryId={searchCategoryId} />
          </div>
        ) }

        {/* Account menu dropdown - desktop */}
        <div class="relative flex-shrink-0">
          <button
            id="account-toggle"
            aria-label="Cuenta"
            aria-expanded="false"
            class="hover:opacity-75 transition"
          >
            <Image
              src={accountImg}
              alt={"account light"}
              class="w-10 h-10 dark:hidden rounded-full"
              inferSize={true}
            />
            <Image
              src={accountImg}
              alt={"account dark"}
              class="w-10 h-10 hidden dark:block rounded-full"
              inferSize={true}
            />
          </button>
          <div
            id="account-menu"
            class="hidden absolute right-0 mt-2 h-48 w-48 border border-slate-300 dark:border-slate-600 rounded-md shadow-lg z-50 bg-slate-50 dark:bg-slate-900 transition-colors duration-300"
            role="menu"
          >
            <AccountMenu client:load lang={lang} />
          </div>
        </div>

        {/* Cart dropdown - desktop */}
        <div class="relative flex-shrink-0">
          <button
            id="cart-toggle"
            aria-label="Carrito"
            aria-expanded="false"
            class="hover:opacity-75 transition relative"
          >
            <Image
              src={cartImg}
              alt={"cart light"}
              class="w-10 h-10 dark:hidden"
              inferSize={true}
            />
            <Image
              src={cartImg}
              alt={"cart dark"}
              class="w-10 h-10 hidden dark:block"
              inferSize={true}
            />
            <CartCount client:load variant="badge" />
          </button>
          <div
            id="cart-menu"
            class="hidden absolute right-0 mt-2 w-64 bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-md shadow-lg z-50 bg-slate-50 dark:bg-slate-900 transition-colors duration-300"
            role="menu"
          >
          <hr class="border-t border-slate-300 dark:border-slate-600 my-1" />
            <a
              href={`/${lang}/products/checkout`}
              class="finalize-purchase"
              class="block px-4 hover:bg-slate-800 py-2 dark:text-slate-100 hover:bg-slate-200 dark:hover:bg-slate-800 transition-colors duration-300"
              role="menuitem"
            >
              Ver carrito
            </a>
            <hr class="border-t border-slate-300 dark:border-slate-600 my-1" />
            <a
              href={`/${lang}/products/checkout`}
              class="finalize-purchase"
              class="block px-4 hover:bg-slate-800 py-2 dark:text-slate-100 hover:bg-slate-200 dark:hover:bg-slate-800 transition-colors duration-300"
              role="menuitem"
            >
              Finalizar compra
            </a>
            <hr class="border-t border-slate-300 dark:border-slate-600 my-1" />
          </div>
        </div>

        {/* Theme toggle button */}
        <div class="flex-shrink-0">
          <ThemeToggle client:load />
        </div>
      </div>
    </div>

    {/* Mobile header (visible only on mobile) */}
    <div class="flex items-center gap-4 md:hidden">
      <ThemeToggle client:load />
      {/* Mobile menu hamburger button */}
      <button id="mobile-toggle" class="text-2xl" aria-label="Abrir menú" aria-expanded="false"
        >☰</button
      >
    </div>
  </div>

  {/* MOBILE NAVIGATION MENU (hidden by default, toggled with hamburger) */}
  <nav
    id="mobile-menu"
    class="md:hidden hidden flex-col gap-4 px-4 py-4 bg-slate-900 text-white border-sky-100 dark:border-slate-600 border-t bg-sky-50 dark:bg-slate-950 transition-colors duration-300"
  >
    {/* Quick links section */}
    <div class="flex items-center gap-4">
      <p class="dark:text-slate-100">Enlaces rapidos:</p>
      {
        home && (
          <a href={`/${lang}/`} class="hover:text-red-400 transition">
            Inicio
          </a>
        )
      }
      <a
        href={`/${lang}/products/allproducts`}
        class="dark:text-slate-100 hover:text-slate-700 dark:hover:text-slate-300 transition py-2"
      >
        Productos
      </a>
      <a
        href={`/${lang}/products/offer`}
        class="dark:text-slate-100 hover:text-slate-700 dark:hover:text-slate-300 transition py-2"
      >
        Ofertas
      </a>
    </div>

    <!-- Mobile search (client) -->
    { showSearch && (
      <div role="search" class="w-full">
        <HeaderSearch client:load placeholder="Buscar productos" categoryId={searchCategoryId} />
      </div>
    ) }

    {/* Mobile account dropdown */}
    <div class="relative mt-2">
      <button
        id="account-toggle-mobile"
        aria-label="Cuenta"
        aria-expanded="false"
        class="hover:opacity-75 bg-slate-900 transition w-full text-left py-2 px-2 border border-slate-300 dark:border-slate-600 rounded dark:text-slate-100"
      >
        Cuenta
      </button>
      <div
        id="account-menu-mobile"
        class="hidden mt-1 w-full border border-slate-300 bg-slate-900 dark:border-slate-600 rounded-md shadow-lg z-50 bg-slate-50 dark:bg-slate-900 transition-colors duration-300"
        role="menu"
      >
        <AccountMenu client:load lang={lang} />
      </div>
    </div>

    {/* Mobile cart dropdown */}
      <div class="relative mt-2">
      <button
        id="cart-toggle-mobile"
        aria-label="Carrito"
        aria-expanded="false"
        class="hover:opacity-75 transition w-full text-left py-2 px-2 border border-slate-300 dark:border-slate-600 rounded text-white bg-slate-900 dark:text-slate-100"
      >
        <CartCount client:load variant="button" />
      </button>
      <div
        id="cart-menu-mobile"
        class="hidden mt-1 w-full border border-slate-300 bg-slate-900 dark:border-slate-600 rounded-md shadow-lg z-50 bg-slate-50 dark:bg-slate-900 transition-colors duration-300"
        role="menu"
      >
        <hr class="border-t border-slate-300 dark:border-slate-600 my-1" />
        <a
          href={`/${lang}/products/checkout`}
          class="finalize-purchase"
          class="block px-4 py-2 dark:text-slate-100 hover:bg-slate-200 dark:hover:bg-slate-800 transition-colors duration-300"
          role="menuitem"
        >
          Ver carrito
        </a>
        <hr class="border-t border-slate-300 dark:border-slate-600 my-1" />
        <a
          href={`/${lang}/products/checkout`}
          class="finalize-purchase"
          class="block px-4 py-2 dark:text-slate-100 hover:bg-slate-200 dark:hover:bg-slate-800 transition-colors duration-300"
          role="menuitem"
        >
          Finalizar compra
        </a>
      </div>
    </div>
  </nav>

  {/* DROPDOWN & MENU TOGGLE SCRIPT */}
  <script is:inline>
    const lang = document.documentElement.lang || "es";

    /**
     * Mobile menu toggle
     * Shows/hides full mobile menu on hamburger button click
     */
    const mobileToggle = document.getElementById("mobile-toggle");
    const mobileMenu = document.getElementById("mobile-menu");
    mobileToggle?.addEventListener("click", (e) => {
      e.stopPropagation();
      mobileMenu.classList.toggle("hidden");
      mobileToggle.setAttribute(
        "aria-expanded",
        mobileMenu.classList.contains("hidden") ? "false" : "true"
      );
    });

    /**
     * Desktop account menu dropdown
     * Shows account menu if logged in, redirects to login page if not
     */
    const accountToggle = document.getElementById("account-toggle");
    const accountMenu = document.getElementById("account-menu");
    accountToggle?.addEventListener("click", (e) => {
      e.stopPropagation();
      if (sessionStorage.getItem("login") !== "true") {
        // Redirect to login page if not authenticated
        window.location.href = `/${lang}/account/login`;
      } else {
        // Show/hide account dropdown
        accountMenu.classList.toggle("hidden");
        accountToggle.setAttribute(
          "aria-expanded",
          accountMenu.classList.contains("hidden") ? "false" : "true"
        );
      }
    });

    /**
     * Desktop cart menu dropdown
     * Shows cart summary with quick links to cart and checkout
     */
    const cartToggle = document.getElementById("cart-toggle");
    const cartMenu = document.getElementById("cart-menu");
    cartToggle?.addEventListener("click", (e) => {
      e.stopPropagation();
      cartMenu.classList.toggle("hidden");
      cartToggle.setAttribute(
        "aria-expanded",
        cartMenu.classList.contains("hidden") ? "false" : "true"
      );
    });

    /**
     * Mobile account menu dropdown
     * Same behavior as desktop but for mobile version
     */
    const accountToggleMobile = document.getElementById("account-toggle-mobile");
    const accountMenuMobile = document.getElementById("account-menu-mobile");
    accountToggleMobile?.addEventListener("click", (e) => {
      e.stopPropagation();
      if (sessionStorage.getItem("login") !== "true") {
        window.location.href = `/${lang}/account/login`;
      } else {
        accountMenuMobile.classList.toggle("hidden");
        accountToggleMobile.setAttribute(
          "aria-expanded",
          accountMenuMobile.classList.contains("hidden") ? "false" : "true"
        );
      }
    });

    /**
     * Mobile cart menu dropdown
     * Same behavior as desktop but for mobile version
     */
    const cartToggleMobile = document.getElementById("cart-toggle-mobile");
    const cartMenuMobile = document.getElementById("cart-menu-mobile");
    cartToggleMobile?.addEventListener("click", (e) => {
      e.stopPropagation();
      cartMenuMobile.classList.toggle("hidden");
      cartToggleMobile.setAttribute(
        "aria-expanded",
        cartMenuMobile.classList.contains("hidden") ? "false" : "true"
      );
    });

    /**
     * Close mobile account menu when link is clicked
     * Automatically collapses dropdown after navigation
     */
    const accountLinksM = accountMenuMobile?.querySelectorAll("a");
    accountLinksM?.forEach((link) => {
      link.addEventListener("click", () => {
        accountMenuMobile?.classList.add("hidden");
        accountToggleMobile?.setAttribute("aria-expanded", "false");
      });
    });

    /**
     * Close mobile cart menu when link is clicked
     * Automatically collapses dropdown after navigation
     */
    const cartLinksM = cartMenuMobile?.querySelectorAll("a");
    cartLinksM?.forEach((link) => {
      link.addEventListener("click", () => {
        cartMenuMobile?.classList.add("hidden");
        cartToggleMobile?.setAttribute("aria-expanded", "false");
      });
    });

    /**
     * Close dropdowns when clicking outside
     * Click detection system that closes menus when user clicks elsewhere
     * Excludes: search inputs, theme toggle, header element (to avoid closing on internal clicks)
     */
    document.addEventListener("click", (e) => {
      const target = e.target;

      // Don't close if clicking on search field
      if (target.closest("input") || target.closest("button[aria-label='Buscar']")) {
        return;
      }

      // Don't close if clicking on theme toggle
      if (target.closest("#theme-toggle") || target.closest(".theme-toggle")) {
        return;
      }

      // Don't close if clicking anywhere in header
      if (target.closest("header")) {
        return;
      }

      // Close all menus if click is outside header
      accountMenu?.classList.add("hidden");
      cartMenu?.classList.add("hidden");
      accountMenuMobile?.classList.add("hidden");
      cartMenuMobile?.classList.add("hidden");
      mobileMenu?.classList.add("hidden");

      // Update aria-expanded attributes
      accountToggle?.setAttribute("aria-expanded", "false");
      cartToggle?.setAttribute("aria-expanded", "false");
      accountToggleMobile?.setAttribute("aria-expanded", "false");
      cartToggleMobile?.setAttribute("aria-expanded", "false");
      mobileToggle?.setAttribute("aria-expanded", "false");
    });
  </script>
  <script type="module">
    import { setupFinalizeLinks } from '/src/lib/headerNavigation.ts';
    // initialize finalize purchase handlers for header links
    try {
      const lang = document.documentElement.lang || 'es';
      setupFinalizeLinks(lang);
    } catch (e) {
      // ignore errors during setup
    }
  </script>
</header>